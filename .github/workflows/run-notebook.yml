name: Run Jupyter Notebook

on:
  push:
    branches:
      - main
    paths:
      - 'notebooks/data-pipeline.ipynb'
      - 'notebooks/requirements.txt'
      - 'notebooks/functions.py'
      - 'data/**'
      - '.github/workflows/run-notebook.yml'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  run-notebook:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        cache: 'pip'
        cache-dependency-path: 'notebooks/requirements.txt'
        
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install jupyter nbconvert nbformat
        pip install -r notebooks/requirements.txt
        
    - name: Install LaTeX for PDF conversion
      run: |
        sudo apt-get update
        sudo apt-get install -y texlive-xetex texlive-fonts-recommended texlive-plain-generic pandoc
        
    - name: Execute notebook
      run: |
        cd notebooks
        jupyter nbconvert --to notebook --execute --inplace data-pipeline.ipynb
        
    - name: Convert to HTML
      run: |
        cd notebooks
        jupyter nbconvert --to html data-pipeline.ipynb
        
    - name: Convert to PDF
      run: |
        cd notebooks
        jupyter nbconvert --to pdf data-pipeline.ipynb
        
    - name: Generate release tag and rename outputs
      id: generate_tag
      run: |
        TIMESTAMP=$(date +%Y%m%d-%H%M%S)
        echo "tag=notebook-output-${TIMESTAMP}" >> $GITHUB_OUTPUT
        echo "release_name=Notebook Output ${TIMESTAMP}" >> $GITHUB_OUTPUT
        echo "timestamp=${TIMESTAMP}" >> $GITHUB_OUTPUT
        
        # Rename output files with timestamp
        cd notebooks
        mv data-pipeline.ipynb data-pipeline-${TIMESTAMP}.ipynb
        mv data-pipeline.html data-pipeline-${TIMESTAMP}.html
        mv data-pipeline.pdf data-pipeline-${TIMESTAMP}.pdf
        
    - name: Create Release
      uses: softprops/action-gh-release@v2
      with:
        tag_name: ${{ steps.generate_tag.outputs.tag }}
        name: ${{ steps.generate_tag.outputs.release_name }}
        body: |
          Automated notebook execution and output generation.
          
          **Files included:**
          - `data-pipeline-${{ steps.generate_tag.outputs.timestamp }}.ipynb` - Executed notebook with output cells
          - `data-pipeline-${{ steps.generate_tag.outputs.timestamp }}.html` - HTML export
          - `data-pipeline-${{ steps.generate_tag.outputs.timestamp }}.pdf` - PDF export
          
          **Triggered by:** ${{ github.event_name }}
          **Commit:** ${{ github.sha }}
        files: |
          notebooks/data-pipeline-${{ steps.generate_tag.outputs.timestamp }}.ipynb
          notebooks/data-pipeline-${{ steps.generate_tag.outputs.timestamp }}.html
          notebooks/data-pipeline-${{ steps.generate_tag.outputs.timestamp }}.pdf
        draft: false
        prerelease: false
